# –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ DXF –ì–µ–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ë–æ—Ç–∞, –≤–∫–ª—é—á–∞—è –º–æ–¥–µ–ª–∏ –ø–æ–¥–ø–∏—Å–æ–∫, –ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä –º–æ–¥–µ–ª–µ–π –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏](#–æ–±–∑–æ—Ä-–º–æ–¥–µ–ª–µ–π-–º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏)
- [SaaS –ø–æ–¥–ø–∏—Å–∫–∞](#saas-–ø–æ–¥–ø–∏—Å–∫–∞)
- [–ü–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É](#–ø–ª–∞—Ç–Ω—ã–π-–¥–æ—Å—Ç—É–ø-–∫-–±–æ—Ç—É)
- [–î–µ—Å–∫—Ç–æ–ø–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ](#–¥–µ—Å–∫—Ç–æ–ø–Ω–æ–µ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
- [–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è](#–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ-—Ä–µ—à–µ–Ω–∏—è)
- [–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–∞](#–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ-–∏—Å—Ç–æ—á–Ω–∏–∫–∏-–¥–æ—Ö–æ–¥–∞)
- [–¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ](#—Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ)
- [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è-–ø–ª–∞—Ç–µ–∂–µ–π)

## –û–±–∑–æ—Ä –º–æ–¥–µ–ª–µ–π –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

| –ú–æ–¥–µ–ª—å | –°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è | –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ | –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è |
|--------|---------------------|---------------------|-------------------|
| Freemium –±–æ—Ç | ‚≠ê –ù–∏–∑–∫–∞—è | üí∞ –°—Ä–µ–¥–Ω–∏–π | –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ |
| SaaS –ø–æ–¥–ø–∏—Å–∫–∞ | ‚≠ê‚≠ê –°—Ä–µ–¥–Ω—è—è | üí∞üí∞ –í—ã—Å–æ–∫–∏–π | –ö–æ–º–ø–∞–Ω–∏–∏, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã |
| –ü–ª–∞—Ç–Ω—ã–π –±–æ—Ç-–¥–æ—Å—Ç—É–ø | ‚≠ê –ù–∏–∑–∫–∞—è | üí∞ –°—Ä–µ–¥–Ω–∏–π | –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã |
| –î–µ—Å–∫—Ç–æ–ø–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ | ‚≠ê‚≠ê‚≠ê –í—ã—Å–æ–∫–∞—è | üí∞üí∞üí∞ –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π | –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã |
| Enterprise —Ä–µ—à–µ–Ω–∏–µ | ‚≠ê‚≠ê‚≠ê –í—ã—Å–æ–∫–∞—è | üí∞üí∞üí∞üí∞ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π | –ö—Ä—É–ø–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ |
| API-–¥–æ—Å—Ç—É–ø | ‚≠ê‚≠ê –°—Ä–µ–¥–Ω—è—è | üí∞üí∞ –í—ã—Å–æ–∫–∏–π | –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä—ã |

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

**–≠—Ç–∞–ø 1 (–º–µ—Å—è—Ü—ã 0-3):** Freemium –º–æ–¥–µ–ª—å –¥–ª—è –Ω–∞–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –±–∞–∑—ã
**–≠—Ç–∞–ø 2 (–º–µ—Å—è—Ü—ã 3-6):** –ó–∞–ø—É—Å–∫ –ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏
**–≠—Ç–∞–ø 3 (–º–µ—Å—è—Ü—ã 6-12):** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ API
**–≠—Ç–∞–ø 4 (–º–µ—Å—è—Ü—ã 12+):** –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–º–∏—É–º —Å–µ–≥–º–µ–Ω—Ç–∞

## SaaS –ø–æ–¥–ø–∏—Å–∫–∞

### –ú–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏

#### Freemium —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω

**–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π (Free)**
- ‚úÖ –î–æ 1,000 —Ç–æ—á–µ–∫ –Ω–∞ –ø—Ä–æ–µ–∫—Ç
- ‚úÖ 5 –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü
- ‚úÖ –ë–∞–∑–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã (3 —à—Ç.)
- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ DXF (R2013)
- ‚úÖ Email –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (48—á)
- ‚ùå –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –Ω–∞ —á–µ—Ä—Ç–µ–∂–∞—Ö

**–°—Ç–∞—Ä—Ç–æ–≤—ã–π (Starter)** - 990‚ÇΩ/–º–µ—Å ($12/–º–µ—Å)
- ‚úÖ –î–æ 10,000 —Ç–æ—á–µ–∫ –Ω–∞ –ø—Ä–æ–µ–∫—Ç
- ‚úÖ 30 –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã (10 —à—Ç.)
- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ DXF (R2018) –∏ PDF
- ‚úÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ TIN
- ‚úÖ –î–µ–Ω—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (–¥–æ 2x)
- ‚úÖ Email –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (24—á)
- ‚úÖ –ë–µ–∑ –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤

**–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π (Professional)** - 2,990‚ÇΩ/–º–µ—Å ($35/–º–µ—Å)
- ‚úÖ –î–æ 100,000 —Ç–æ—á–µ–∫ –Ω–∞ –ø—Ä–æ–µ–∫—Ç
- ‚úÖ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–µ–∫—Ç–æ–≤
- ‚úÖ –í—Å–µ —à–∞–±–ª–æ–Ω—ã + –∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–∏—Ö
- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ DXF, PDF, PNG, SVG
- ‚úÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ TIN —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- ‚úÖ –î–µ–Ω—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (–¥–æ 5x)
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å LAS/LAZ —Ñ–∞–π–ª–∞–º–∏
- ‚úÖ –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (12—á)
- ‚úÖ API –¥–æ—Å—Ç—É–ø (1000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å)

**–ë–∏–∑–Ω–µ—Å (Business)** - 9,990‚ÇΩ/–º–µ—Å ($120/–º–µ—Å)
- ‚úÖ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫
- ‚úÖ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–µ–∫—Ç–æ–≤
- ‚úÖ –í—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Professional
- ‚úÖ –ë–µ–ª—ã–π –ª–µ–π–±–ª (—Å–≤–æ–π –±—Ä–µ–Ω–¥–∏–Ω–≥)
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ API –¥–æ—Å—Ç—É–ø (–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
- ‚úÖ –í—ã–¥–µ–ª–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7
- ‚úÖ SLA –≥–∞—Ä–∞–Ω—Ç–∏–∏
- ‚úÖ –û–±—É—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

**Enterprise** - –æ—Ç 29,990‚ÇΩ/–º–µ—Å (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ)
- ‚úÖ –í—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Business
- ‚úÖ On-premise —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- ‚úÖ –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ì–ò–° —Å–∏—Å—Ç–µ–º–∞–º–∏
- ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
- ‚úÖ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫

#### –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

```python
# src/models/subscription.py

from enum import Enum
from datetime import datetime, timedelta
from dataclasses import dataclass
from typing import Optional

class SubscriptionTier(Enum):
    """–£—Ä–æ–≤–Ω–∏ –ø–æ–¥–ø–∏—Å–∫–∏"""
    FREE = "free"
    STARTER = "starter"
    PROFESSIONAL = "professional"
    BUSINESS = "business"
    ENTERPRISE = "enterprise"

@dataclass
class SubscriptionLimits:
    """–õ–∏–º–∏—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏"""
    max_points_per_project: int
    max_projects_per_month: int
    max_file_size_mb: int
    has_api_access: bool
    api_requests_per_day: Optional[int]
    has_batch_processing: bool
    has_las_support: bool
    support_response_time_hours: int
    watermark: bool

class Subscription:
    """–ú–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏"""
    
    TIER_LIMITS = {
        SubscriptionTier.FREE: SubscriptionLimits(
            max_points_per_project=1_000,
            max_projects_per_month=5,
            max_file_size_mb=5,
            has_api_access=False,
            api_requests_per_day=None,
            has_batch_processing=False,
            has_las_support=False,
            support_response_time_hours=48,
            watermark=True
        ),
        SubscriptionTier.STARTER: SubscriptionLimits(
            max_points_per_project=10_000,
            max_projects_per_month=30,
            max_file_size_mb=20,
            has_api_access=False,
            api_requests_per_day=None,
            has_batch_processing=False,
            has_las_support=False,
            support_response_time_hours=24,
            watermark=False
        ),
        SubscriptionTier.PROFESSIONAL: SubscriptionLimits(
            max_points_per_project=100_000,
            max_projects_per_month=-1,  # Unlimited
            max_file_size_mb=100,
            has_api_access=True,
            api_requests_per_day=1_000,
            has_batch_processing=True,
            has_las_support=True,
            support_response_time_hours=12,
            watermark=False
        ),
        SubscriptionTier.BUSINESS: SubscriptionLimits(
            max_points_per_project=-1,  # Unlimited
            max_projects_per_month=-1,
            max_file_size_mb=500,
            has_api_access=True,
            api_requests_per_day=-1,  # Unlimited
            has_batch_processing=True,
            has_las_support=True,
            support_response_time_hours=1,
            watermark=False
        ),
    }
    
    def __init__(self, user_id: int, tier: SubscriptionTier,
                 expires_at: datetime):
        self.user_id = user_id
        self.tier = tier
        self.expires_at = expires_at
        self.created_at = datetime.now()
    
    @property
    def is_active(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏"""
        return datetime.now() < self.expires_at
    
    @property
    def limits(self) -> SubscriptionLimits:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏"""
        return self.TIER_LIMITS[self.tier]
    
    def can_process_points(self, points_count: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ—á–µ–∫"""
        max_points = self.limits.max_points_per_project
        return max_points == -1 or points_count <= max_points
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤

```python
# src/services/subscription_service.py

from src.models.subscription import Subscription, SubscriptionTier
from src.database.models import User, Project
from datetime import datetime

class SubscriptionService:
    """–°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏"""
    
    async def get_user_subscription(self, user_id: int) -> Subscription:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ë–î
        user = await User.get(user_id)
        
        if user.subscription_tier and user.subscription_expires_at:
            return Subscription(
                user_id=user_id,
                tier=SubscriptionTier(user.subscription_tier),
                expires_at=user.subscription_expires_at
            )
        
        # –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return Subscription(
            user_id=user_id,
            tier=SubscriptionTier.FREE,
            expires_at=datetime.max
        )
    
    async def check_project_limit(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∑–∞ –º–µ—Å—è—Ü"""
        subscription = await self.get_user_subscription(user_id)
        
        if subscription.limits.max_projects_per_month == -1:
            return True
        
        # –ü–æ–¥—Å—á–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        current_month_projects = await Project.count_by_user_this_month(user_id)
        
        return current_month_projects < subscription.limits.max_projects_per_month
    
    async def upgrade_subscription(self, user_id: int, 
                                   new_tier: SubscriptionTier,
                                   payment_id: str) -> Subscription:
        """–ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ø–æ–¥–ø–∏—Å–∫–∏"""
        user = await User.get(user_id)
        
        # –†–∞—Å—á–µ—Ç –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è
        if new_tier == SubscriptionTier.FREE:
            expires_at = datetime.max
        else:
            expires_at = datetime.now() + timedelta(days=30)
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î
        user.subscription_tier = new_tier.value
        user.subscription_expires_at = expires_at
        user.last_payment_id = payment_id
        await user.save()
        
        return Subscription(user_id, new_tier, expires_at)
```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ—Ç

```python
# src/bot/handlers.py

from src.services.subscription_service import SubscriptionService

async def new_project_handler(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–æ–≤"""
    user_id = update.effective_user.id
    
    subscription_service = SubscriptionService()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
    can_create = await subscription_service.check_project_limit(user_id)
    
    if not can_create:
        subscription = await subscription_service.get_user_subscription(user_id)
        await update.message.reply_text(
            f"‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞ {subscription.tier.value}\n"
            f"–õ–∏–º–∏—Ç: {subscription.limits.max_projects_per_month} –ø—Ä–æ–µ–∫—Ç–æ–≤/–º–µ—Å—è—Ü\n\n"
            f"–ü–æ–≤—ã—Å—å—Ç–µ —Ç–∞—Ä–∏—Ñ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤: /upgrade"
        )
        return
    
    # –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
    context.user_data['state'] = 'AWAITING_FILE'
    await update.message.reply_text("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏")

async def upgrade_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞"""
    user_id = update.effective_user.id
    subscription_service = SubscriptionService()
    subscription = await subscription_service.get_user_subscription(user_id)
    
    keyboard = [
        [InlineKeyboardButton("Starter - 990‚ÇΩ/–º–µ—Å", callback_data="upgrade_starter")],
        [InlineKeyboardButton("Professional - 2,990‚ÇΩ/–º–µ—Å", callback_data="upgrade_professional")],
        [InlineKeyboardButton("Business - 9,990‚ÇΩ/–º–µ—Å", callback_data="upgrade_business")],
        [InlineKeyboardButton("Enterprise - —Å–≤—è–∑–∞—Ç—å—Å—è", url="https://t.me/support")]
    ]
    
    await update.message.reply_text(
        f"–í–∞—à —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ: {subscription.tier.value}\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
```

## –ü–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É

### –ú–æ–¥–µ–ª—å –æ–ø–ª–∞—Ç—ã –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (Pay-as-you-go)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥ –≤—Ö–æ–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û–ø–ª–∞—Ç–∞ —Ç–æ–ª—å–∫–æ –∑–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- –ì–∏–±–∫–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ

**–¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:**
- 10‚ÇΩ –∑–∞ 1,000 —Ç–æ—á–µ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- 50‚ÇΩ –∑–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ TIN
- 30‚ÇΩ –∑–∞ –¥–µ–Ω—Å–∏—Ñ–∏–∫–∞—Ü–∏—é
- 100‚ÇΩ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É LAS —Ñ–∞–π–ª–∞

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫—Ä–µ–¥–∏—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

```python
# src/models/credits.py

from dataclasses import dataclass
from datetime import datetime

@dataclass
class CreditPack:
    """–ü–∞–∫–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤"""
    name: str
    credits: int
    price_rub: int
    bonus_credits: int = 0
    
    @property
    def total_credits(self) -> int:
        return self.credits + self.bonus_credits

# –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
CREDIT_PACKS = [
    CreditPack("–ù–∞—á–∞–ª—å–Ω—ã–π", credits=100, price_rub=500, bonus_credits=0),
    CreditPack("–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π", credits=500, price_rub=2000, bonus_credits=50),
    CreditPack("–ü—Ä–µ–º–∏—É–º", credits=1500, price_rub=5000, bonus_credits=300),
    CreditPack("–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π", credits=5000, price_rub=15000, bonus_credits=1500),
]

class CreditAccount:
    """–ê–∫–∫–∞—É–Ω—Ç —Å –∫—Ä–µ–¥–∏—Ç–∞–º–∏"""
    
    OPERATION_COSTS = {
        'process_1000_points': 10,
        'build_tin': 50,
        'densify': 30,
        'process_las': 100,
        'export_pdf': 20,
        'api_request': 1,
    }
    
    def __init__(self, user_id: int, balance: int = 0):
        self.user_id = user_id
        self.balance = balance
    
    def has_credits(self, operation: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏"""
        cost = self.OPERATION_COSTS.get(operation, 0)
        return self.balance >= cost
    
    def charge(self, operation: str, multiplier: float = 1.0) -> bool:
        """–°–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é"""
        cost = int(self.OPERATION_COSTS.get(operation, 0) * multiplier)
        
        if self.balance >= cost:
            self.balance -= cost
            return True
        return False
    
    def add_credits(self, amount: int):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤"""
        self.balance += amount
```

## –î–µ—Å–∫—Ç–æ–ø–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

**–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:**
- –ì–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
- –ü—Ä–æ–µ–∫—Ç–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- –ö—Ä—É–ø–Ω—ã–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
- ‚úÖ –†–∞–±–æ—Ç–∞ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ (–º–∏–ª–ª–∏–æ–Ω—ã —Ç–æ—á–µ–∫)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ CAD —Å–∏—Å—Ç–µ–º–∞–º–∏
- ‚úÖ –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

```
Desktop Application Stack:
‚îú‚îÄ‚îÄ Frontend: Electron + React
‚îú‚îÄ‚îÄ Backend: Python (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)
‚îú‚îÄ‚îÄ Processing: NumPy, SciPy (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
‚îî‚îÄ‚îÄ CAD Engine: ezdxf, pythonOCC
```

### –ú–æ–¥–µ–ª—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è

**–í–∞—Ä–∏–∞–Ω—Ç 1: Perpetual License (–±–µ—Å—Å—Ä–æ—á–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è)**
- –ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞: 49,990‚ÇΩ
- –í–∫–ª—é—á–∞–µ—Ç 1 –≥–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏: 9,990‚ÇΩ/–≥–æ–¥

**–í–∞—Ä–∏–∞–Ω—Ç 2: Subscription License (–ø–æ–¥–ø–∏—Å–∫–∞)**
- –ì–æ–¥–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞: 19,990‚ÇΩ/–≥–æ–¥
- –í–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É
- –°–∫–∏–¥–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ 3 –≥–æ–¥–∞: 49,990‚ÇΩ

**–í–∞—Ä–∏–∞–Ω—Ç 3: Network License (—Å–µ—Ç–µ–≤–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è)**
- –û—Ç 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –¶–µ–Ω–∞: –æ—Ç 149,990‚ÇΩ + 29,990‚ÇΩ/–≥–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
desktop-app/
‚îú‚îÄ‚îÄ electron/              # Electron –æ–±–æ–ª–æ—á–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ main.js           # –ì–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
‚îÇ   ‚îú‚îÄ‚îÄ preload.js        # Preload —Å–∫—Ä–∏–ø—Ç
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ
‚îú‚îÄ‚îÄ frontend/             # React –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ
‚îú‚îÄ‚îÄ backend/              # Python backend
‚îÇ   ‚îú‚îÄ‚îÄ api/             # REST API –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ processors/      # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt
‚îÇ
‚îú‚îÄ‚îÄ build/               # –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ windows/
‚îÇ   ‚îú‚îÄ‚îÄ macos/
‚îÇ   ‚îî‚îÄ‚îÄ linux/
‚îÇ
‚îî‚îÄ‚îÄ installer/           # –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∏
    ‚îú‚îÄ‚îÄ windows.nsis
    ‚îú‚îÄ‚îÄ macos.dmg
    ‚îî‚îÄ‚îÄ linux.AppImage
```

### –°–∏—Å—Ç–µ–º–∞ –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏—è

```python
# backend/licensing.py

import hashlib
import json
from datetime import datetime, timedelta
from cryptography.fernet import Fernet
import uuid

class LicenseManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –ª–∏—Ü–µ–Ω–∑–∏–π"""
    
    def __init__(self, secret_key: bytes):
        self.cipher = Fernet(secret_key)
    
    def generate_license(self, user_info: dict, license_type: str,
                        duration_days: int = 365) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞"""
        license_data = {
            'user_id': user_info['user_id'],
            'email': user_info['email'],
            'company': user_info.get('company', ''),
            'type': license_type,  # perpetual, subscription, network
            'issued_at': datetime.now().isoformat(),
            'expires_at': (datetime.now() + timedelta(days=duration_days)).isoformat(),
            'machine_id': user_info.get('machine_id', ''),
            'features': self._get_features_for_type(license_type),
        }
        
        # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏
        license_json = json.dumps(license_data)
        encrypted = self.cipher.encrypt(license_json.encode())
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–∏—Ç–∞–µ–º–æ–≥–æ –∫–ª—é—á–∞
        license_key = self._format_license_key(encrypted)
        
        return license_key
    
    def validate_license(self, license_key: str, machine_id: str) -> dict:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏"""
        try:
            # –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
            encrypted = self._parse_license_key(license_key)
            decrypted = self.cipher.decrypt(encrypted)
            license_data = json.loads(decrypted.decode())
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
            expires_at = datetime.fromisoformat(license_data['expires_at'])
            if datetime.now() > expires_at and license_data['type'] != 'perpetual':
                return {'valid': False, 'reason': 'expired'}
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –º–∞—à–∏–Ω–µ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)
            if license_data.get('machine_id') and \
               license_data['machine_id'] != machine_id:
                return {'valid': False, 'reason': 'machine_mismatch'}
            
            return {'valid': True, 'license_data': license_data}
        
        except Exception as e:
            return {'valid': False, 'reason': str(e)}
    
    def _get_features_for_type(self, license_type: str) -> list:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ç–∏–ø–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏"""
        features_map = {
            'perpetual': ['all_features', 'offline', 'unlimited_projects'],
            'subscription': ['all_features', 'offline', 'unlimited_projects', 'updates'],
            'network': ['all_features', 'offline', 'unlimited_projects', 
                       'updates', 'central_management'],
        }
        return features_map.get(license_type, [])
    
    def _format_license_key(self, encrypted: bytes) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞ –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥"""
        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ hex –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –≥—Ä—É–ø–ø—ã
        hex_key = encrypted.hex().upper()
        groups = [hex_key[i:i+4] for i in range(0, len(hex_key), 4)]
        return '-'.join(groups[:8])  # –ü–µ—Ä–≤—ã–µ 8 –≥—Ä—É–ø–ø –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
    
    def _parse_license_key(self, license_key: str) -> bytes:
        """–ü–∞—Ä—Å–∏–Ω–≥ –∫–ª—é—á–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ bytes"""
        hex_key = license_key.replace('-', '')
        return bytes.fromhex(hex_key)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
license_manager = LicenseManager(secret_key=b'your-secret-key-here')

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏
user_info = {
    'user_id': 12345,
    'email': 'user@company.com',
    'company': 'GeoTech LLC',
    'machine_id': uuid.getnode()  # MAC –∞–¥—Ä–µ—Å
}
license_key = license_manager.generate_license(
    user_info, 
    license_type='subscription',
    duration_days=365
)

# –í–∞–ª–∏–¥–∞—Ü–∏—è
result = license_manager.validate_license(license_key, str(uuid.getnode()))
if result['valid']:
    print("–õ–∏—Ü–µ–Ω–∑–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞")
else:
    print(f"–û—à–∏–±–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏: {result['reason']}")
```

## –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### Enterprise Package

**–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:**
- ‚úÖ On-premise —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (AD, SSO)
- ‚úÖ –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ì–ò–° —Å–∏—Å—Ç–µ–º–∞–º–∏
- ‚úÖ –û–±—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞
- ‚úÖ –í—ã–¥–µ–ª–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7
- ‚úÖ SLA –≥–∞—Ä–∞–Ω—Ç–∏–∏ 99.9%
- ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä

**–¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:**
- –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: 499,990‚ÇΩ
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: –æ—Ç 199,990‚ÇΩ
- –ì–æ–¥–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞: 149,990‚ÇΩ
- –û–±—É—á–µ–Ω–∏–µ (3 –¥–Ω—è): 99,990‚ÇΩ

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

```python
# src/integrations/corporate.py

from typing import Protocol
import ldap
import requests

class SSOProvider(Protocol):
    """–ü—Ä–æ—Ç–æ–∫–æ–ª SSO –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"""
    def authenticate(self, token: str) -> dict: ...

class ActiveDirectorySSO:
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Active Directory"""
    
    def __init__(self, server: str, base_dn: str):
        self.server = server
        self.base_dn = base_dn
    
    def authenticate(self, username: str, password: str) -> dict:
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ AD"""
        try:
            conn = ldap.initialize(f'ldap://{self.server}')
            user_dn = f'cn={username},{self.base_dn}'
            conn.simple_bind_s(user_dn, password)
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            result = conn.search_s(
                user_dn, 
                ldap.SCOPE_BASE,
                attrlist=['mail', 'displayName', 'department']
            )
            
            user_data = result[0][1]
            
            return {
                'authenticated': True,
                'email': user_data.get('mail', [b''])[0].decode(),
                'name': user_data.get('displayName', [b''])[0].decode(),
                'department': user_data.get('department', [b''])[0].decode(),
            }
        
        except ldap.INVALID_CREDENTIALS:
            return {'authenticated': False, 'error': 'Invalid credentials'}
        except Exception as e:
            return {'authenticated': False, 'error': str(e)}

class GISIntegration:
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ì–ò–° —Å–∏—Å—Ç–µ–º–∞–º–∏"""
    
    def __init__(self, gis_api_url: str, api_key: str):
        self.api_url = gis_api_url
        self.api_key = api_key
    
    def export_to_gis(self, project_id: str, layer_name: str) -> bool:
        """–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ì–ò–° —Å–∏—Å—Ç–µ–º—É"""
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞
        project_data = self._get_project_data(project_id)
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ GeoJSON
        geojson = self._convert_to_geojson(project_data)
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ì–ò–°
        response = requests.post(
            f'{self.api_url}/layers/{layer_name}/features',
            headers={'Authorization': f'Bearer {self.api_key}'},
            json=geojson
        )
        
        return response.status_code == 201
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–∞

### 1. API Marketplace

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ API –¥–ª—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:

```python
# API —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
API_PRICING = {
    'free': {
        'requests_per_month': 1_000,
        'rate_limit': '10/minute',
        'price': 0
    },
    'developer': {
        'requests_per_month': 10_000,
        'rate_limit': '100/minute',
        'price': 2_990  # —Ä—É–±/–º–µ—Å
    },
    'business': {
        'requests_per_month': 100_000,
        'rate_limit': '1000/minute',
        'price': 19_990
    },
    'enterprise': {
        'requests_per_month': -1,  # unlimited
        'rate_limit': '10000/minute',
        'price': 'custom'
    }
}
```

### 2. –ü–ª–∞—Ç–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

**–ú–∞–≥–∞–∑–∏–Ω —à–∞–±–ª–æ–Ω–æ–≤:**
- –û—Ç—Ä–∞—Å–ª–µ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã: 990‚ÇΩ
- –ü—Ä–µ–º–∏—É–º —à–∞–±–ª–æ–Ω—ã: 2,990‚ÇΩ
- –ü–∞–∫–µ—Ç—ã —à–∞–±–ª–æ–Ω–æ–≤: 9,990‚ÇΩ

**–†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:**
- –ú–æ–¥—É–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤: 4,990‚ÇΩ
- –ú–æ–¥—É–ª—å 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏: 7,990‚ÇΩ
- –ú–æ–¥—É–ª—å –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ª—å–µ—Ñ–∞: 5,990‚ÇΩ

### 3. –û–±—É—á–µ–Ω–∏–µ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

**–û–Ω–ª–∞–π–Ω –∫—É—Ä—Å—ã:**
- –ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å: 4,990‚ÇΩ
- –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∫—É—Ä—Å: 9,990‚ÇΩ
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: 19,990‚ÇΩ

**–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ:**
- –í–µ–±–∏–Ω–∞—Ä (2 —á–∞—Å–∞): 29,990‚ÇΩ
- –¢—Ä–µ–Ω–∏–Ω–≥ (1 –¥–µ–Ω—å): 79,990‚ÇΩ
- –ü–æ–ª–Ω—ã–π –∫—É—Ä—Å (3 –¥–Ω—è): 199,990‚ÇΩ

### 4. –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏

- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è (1 —á–∞—Å): 4,990‚ÇΩ
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: –æ—Ç 49,990‚ÇΩ
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ custom —Ä–µ—à–µ–Ω–∏–π: –æ—Ç 199,990‚ÇΩ

## –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ

### –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü–µ–Ω

```python
# src/services/pricing_calculator.py

from dataclasses import dataclass
from typing import Dict

@dataclass
class PricingFactors:
    """–§–∞–∫—Ç–æ—Ä—ã —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è"""
    points_count: int
    has_tin: bool = False
    has_densification: bool = False
    densification_factor: float = 1.0
    export_formats: list = None
    processing_time_seconds: float = 0
    
    def __post_init__(self):
        if self.export_formats is None:
            self.export_formats = ['dxf']

class PricingCalculator:
    """–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
    
    # –ë–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã (–≤ —Ä—É–±–ª—è—Ö)
    PRICE_PER_1000_POINTS = 10
    PRICE_TIN = 50
    PRICE_DENSIFICATION_BASE = 30
    EXPORT_PRICES = {
        'dxf': 0,
        'pdf': 20,
        'png': 10,
        'svg': 15,
    }
    
    def calculate_cost(self, factors: PricingFactors) -> Dict:
        """–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏"""
        cost_breakdown = {}
        
        # –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ—á–µ–∫
        points_cost = (factors.points_count / 1000) * self.PRICE_PER_1000_POINTS
        cost_breakdown['points'] = points_cost
        
        # –°—Ç–æ–∏–º–æ—Å—Ç—å TIN
        if factors.has_tin:
            cost_breakdown['tin'] = self.PRICE_TIN
        
        # –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–µ–Ω—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if factors.has_densification:
            densify_cost = self.PRICE_DENSIFICATION_BASE * factors.densification_factor
            cost_breakdown['densification'] = densify_cost
        
        # –°—Ç–æ–∏–º–æ—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞
        export_cost = sum(
            self.EXPORT_PRICES.get(fmt, 0)
            for fmt in factors.export_formats
        )
        cost_breakdown['export'] = export_cost
        
        # –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
        total = sum(cost_breakdown.values())
        
        return {
            'total': round(total, 2),
            'breakdown': cost_breakdown,
            'currency': 'RUB'
        }

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
calculator = PricingCalculator()

factors = PricingFactors(
    points_count=15_000,
    has_tin=True,
    has_densification=True,
    densification_factor=2.0,
    export_formats=['dxf', 'pdf']
)

cost = calculator.calculate_cost(factors)
print(f"–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏: {cost['total']} —Ä—É–±.")
print(f"–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è: {cost['breakdown']}")
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

#### –ÆKassa (–†–æ—Å—Å–∏—è)

```python
# src/payments/yookassa.py

from yookassa import Configuration, Payment
import uuid

Configuration.account_id = 'your_shop_id'
Configuration.secret_key = 'your_secret_key'

class YooKassaPayment:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –ÆKassa"""
    
    def create_payment(self, amount: float, description: str,
                      user_id: int, return_url: str) -> dict:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞"""
        
        payment = Payment.create({
            "amount": {
                "value": str(amount),
                "currency": "RUB"
            },
            "confirmation": {
                "type": "redirect",
                "return_url": return_url
            },
            "capture": True,
            "description": description,
            "metadata": {
                "user_id": user_id,
                "order_id": str(uuid.uuid4())
            }
        }, uuid.uuid4())
        
        return {
            'payment_id': payment.id,
            'confirmation_url': payment.confirmation.confirmation_url,
            'status': payment.status
        }
    
    def check_payment(self, payment_id: str) -> dict:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞"""
        payment = Payment.find_one(payment_id)
        
        return {
            'payment_id': payment.id,
            'status': payment.status,
            'paid': payment.paid,
            'amount': float(payment.amount.value),
            'metadata': payment.metadata
        }
```

#### Telegram Payments

```python
# src/bot/payments.py

from telegram import LabeledPrice, Update
from telegram.ext import CallbackContext

async def send_invoice(update: Update, context: CallbackContext,
                      title: str, description: str,
                      price: int, currency: str = 'RUB'):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å—á–µ—Ç–∞ —á–µ—Ä–µ–∑ Telegram Payments"""
    
    chat_id = update.effective_chat.id
    
    await context.bot.send_invoice(
        chat_id=chat_id,
        title=title,
        description=description,
        payload='subscription_payment',
        provider_token=PAYMENT_PROVIDER_TOKEN,
        currency=currency,
        prices=[LabeledPrice(title, price * 100)],  # –≤ –∫–æ–ø–µ–π–∫–∞—Ö
        start_parameter='subscription',
        photo_url='https://your-site.com/subscription-image.png',
        photo_size=512,
        photo_width=512,
        photo_height=512,
        need_email=True,
    )

async def precheckout_callback(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ pre-checkout –∑–∞–ø—Ä–æ—Å–∞"""
    query = update.pre_checkout_query
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞
    if query.invoice_payload == 'subscription_payment':
        await query.answer(ok=True)
    else:
        await query.answer(
            ok=False,
            error_message="–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫..."
        )

async def successful_payment_callback(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
    payment = update.message.successful_payment
    user_id = update.effective_user.id
    
    # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
    subscription_service = SubscriptionService()
    await subscription_service.upgrade_subscription(
        user_id,
        SubscriptionTier.STARTER,
        payment.provider_payment_charge_id
    )
    
    await update.message.reply_text(
        "‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!\n"
        "–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞."
    )
```

### Webhook –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö

```python
# src/api/webhooks.py

from fastapi import FastAPI, Request
import hashlib
import hmac

app = FastAPI()

@app.post("/webhooks/yookassa")
async def yookassa_webhook(request: Request):
    """Webhook –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –ÆKassa"""
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    body = await request.body()
    notification = await request.json()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
    signature = request.headers.get('X-Signature')
    if not verify_signature(body, signature):
        return {"error": "Invalid signature"}, 403
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    event_type = notification.get('event')
    payment_data = notification.get('object')
    
    if event_type == 'payment.succeeded':
        await handle_successful_payment(payment_data)
    elif event_type == 'payment.canceled':
        await handle_canceled_payment(payment_data)
    
    return {"status": "ok"}

def verify_signature(body: bytes, signature: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook"""
    secret_key = 'your_webhook_secret'
    expected_signature = hmac.new(
        secret_key.encode(),
        body,
        hashlib.sha256
    ).hexdigest()
    
    return hmac.compare_digest(expected_signature, signature)

async def handle_successful_payment(payment_data: dict):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
    user_id = payment_data['metadata']['user_id']
    amount = float(payment_data['amount']['value'])
    
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ —Å—É–º–º–µ
    tier_map = {
        990: SubscriptionTier.STARTER,
        2990: SubscriptionTier.PROFESSIONAL,
        9990: SubscriptionTier.BUSINESS,
    }
    
    tier = tier_map.get(int(amount))
    
    if tier:
        subscription_service = SubscriptionService()
        await subscription_service.upgrade_subscription(
            user_id, tier, payment_data['id']
        )
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await send_notification(user_id, 
            f"‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ {tier.value} —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!"
        )
```

---

[‚Üê –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](./deployment.md) | [README ‚Üí](../README.md)
